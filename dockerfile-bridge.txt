FROM --platform=linux/arm64/v8 python:3.12-slim
# FROM mcp/memory:latest

# Install Python for the bridge
# RUN apk add --no-cache python3 py3-pip bash curl git nodejs npm unzip

# Install ngrok
RUN apt-get update && apt-get install -y curl git nodejs npm wget unzip && rm -rf /var/lib/apt/lists/*
RUN curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | \
    tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null && \
    echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | \
    tee /etc/apt/sources.list.d/ngrok.list && \
    apt-get update && \
    apt-get install -y ngrok

# Copy Python bridge
WORKDIR /bridge
COPY .ngrok requirements/bridge.txt knowledge.py ./
RUN pip3 install --break-system-packages --no-cache-dir -r bridge.txt

# Clone MCP server
RUN git clone https://github.com/modelcontextprotocol/servers.git mcp
WORKDIR /bridge/mcp/src/memory
#UN npm install --silent --no-progress --legacy-peer-deps
RUN npm ci --ignore-scripts --omit-dev
RUN npm run build

EXPOSE 8000
CMD ["python3", "/bridge/knowledge.py"]

