FROM --platform=linux/arm64/v8 python:3.12-slim
# FROM mcp/memory:latest

# Install system dependencies
RUN apt-get update && apt-get install -y \
    curl \
    git \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# Install ngrok
RUN curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | \
    tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null && \
    echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | \
    tee /etc/apt/sources.list.d/ngrok.list && \
    apt-get update && \
    apt-get install -y ngrok

WORKDIR /bridge

# Copy requirements
COPY .ngrok requirements/bridge.txt knowledge.py ./

# Install Python dependencies
RUN pip install --break-system-packages --no-cache-dir -r bridge.txt

# Install mcp-memory (the MCP server that runs in stdio mode)
RUN pip install --no-cache-dir mcp-memory

# Expose port for the bridge server
EXPOSE 8000

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8000/health || exit 1

# Run the FastAPI bridge server
CMD ["python", "-m", "uvicorn", "knowledge:app", "--host", "0.0.0.0", "--port", "8000"]
